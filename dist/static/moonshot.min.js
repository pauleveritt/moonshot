/*

 Declare the module with dependencies, and nothing more.

 */

var appModules = [
  'ngAnimate', 'ngMessages', 'ui.router', 'restangular', 'satellizer',
  'mgcrea.ngStrap',
  'traverser'
];

if (document.URL.indexOf(':9000') != -1) {
  appModules.push('ngMockE2E');
  appModules.push('moonshotMock');
}
angular.module('moonshot', appModules)
  .value('mockRest', {});


/*

 When running in dev mode, mock calls to the REST API
 but pass everything else through.

 */

(function (ng, mod, _, undefined) {
  'use strict';

  mod.run(function ($httpBackend, moonshotMockRest) {

    var mocks = moonshotMockRest.getMocks();

    // Iterate over all the registered mocks and register them
    _.map(mocks, function (moduleMocks) {
      // All the mocks registered for this module
      _(moduleMocks).forEach(function (mock) {
        var method = mock[0];
        var match = mock[1],
          responder = mock[2];
        $httpBackend.when(
          method,
          match)
          .respond(responder);
      });
    });

    // pass through everything else
    $httpBackend.whenGET(/\/*/).passThrough();
    $httpBackend.whenPOST(/\/*/).passThrough();
    $httpBackend.whenPUT(/\/*/).passThrough();

  });

}(angular, angular.module('moonshotMock', ['moonshot', 'ngMockE2E']), _));

(function () {

  function MoonshotMocks() {
    this.mocks = {};

    this.$get = function () {
      var mocks = this.mocks;
      return {
        getMocks: function () {
          return mocks;
        }
      };
    };

    this.addMock = function (k, v) {
      this.mocks[k] = v;
    };
  }

  function ModuleInit() {
    /* Empty for now */
  }

  angular.module("moonshot")
    .provider('moonshotMockRest', MoonshotMocks)
    .config(ModuleInit);


})();

(function () {

  function HeaderCtrl($rootScope, $state, $auth) {
    var ctrl = this;
    this.$rootScope = $rootScope;
    this.$state = $state;
    this.$auth = $auth;

    this.sections = _($state.get())
      .filter(function (state) {
                return _.has(state, "section");
              })
      .map(function (state) {
             var s = state.section;
             return {
               title: s.title,
               priority: s.priority ? s.priority : 99,
               state: state.name
             };
           })
      .sortBy("priority")
      .value();

    // When the state changes, update the subsections
    this.subsections = this.$state.current.subsections;
    $rootScope.$on('$stateChangeSuccess', ctrl.updateSubsections);
    $rootScope.$on('$stateChangeSuccess', function (event, toState) {
      $rootScope.$evalAsync(function () {
        // Wrap in $evalAsync as we are re-assigning a list
        ctrl.subsections = toState.subsections;
      });
    });
  }


  function NotFoundCtrl($location) {
    this.path = $location.path();
  }

  function ErrorCtrl($stateParams) {
    this.toState = $stateParams.toState;
    this.error = $stateParams.error;
  }


  angular.module("moonshot")
    .controller("HeaderCtrl", HeaderCtrl)
    .controller("NotFoundCtrl", NotFoundCtrl)
    .controller("ErrorCtrl", ErrorCtrl);

})();

(function () {

  function RestLogger($q, $log, $injector) {

    return {
      request: function (config) {
        var isApi = config.url.substring(0, 5) == '/api/';
        if (1 == 1) {
          $log.info('request url/method/data',
                    config.url, config.method, config.data);
        }
        return config || $q.when(config);
      },
      response: function (response) {
        var config = response.config;
        var isApi = config.url.substring(0, 5) == '/api/';
        if (1 == 1) {
          var response_data = response.data;
          $log.info('response url/method/data',
                    config.url, config.method);
        }
        return response || $q.when(response);
      },
      responseError: function (rejection) {
        // Handle any 500 errors from the server with an alert
        var $alert = $injector.get('$alert');

        var url = rejection.config.url;
        if (rejection.status == 500) {
          var msg = 'Server error at: ' + url;
          $alert({
                   content: msg,
                   animation: 'fadeZoomFadeDown',
                   type: 'material',
                   duration: 3
                 });
        }
        return $q.reject(rejection);
      }

    };
  }


  function ModuleInit($httpProvider) {

    $httpProvider.interceptors.push('restLogger');
  }

  angular.module("moonshot")
    .factory('restLogger', RestLogger)
    .config(ModuleInit);

})();

(function () {

  function ModuleInit($stateProvider, $urlRouterProvider, RestangularProvider) {

    RestangularProvider.setBaseUrl('http://127.0.0.1:3000/api');

    $stateProvider
      .state('siteroot', {
               abstract: true,
               url: "",
               views: {
                 "header": {
                   templateUrl: '/app/header.partial.html',
                   controller: "HeaderCtrl as HeaderCtrl"
                 },
                 "content": {
                   template: '<div ui-view="content"></div>'
                 }
               }
             })

      // NotFound, Error, and Forbidden views
      .state("notfound", {
               parent: "siteroot",
               views: {
                 "content": {
                   templateUrl: "/app/notfound.partial.html",
                   controller: "NotFoundCtrl as NotFoundCtrl"

                 }
               },
               params: ["unfoundStateTo"]
             })
      .state("error", {
               parent: "siteroot",
               views: {
                 "content": {
                   templateUrl: "/app/error.partial.html",
                   controller: "ErrorCtrl as ErrorCtrl"
                 }
               },
               params: ["toState", "error"]
             })

      // "Busted" state to demonstrate error handling when the
      // state-logic throws an exception.
      .state("busted", {
               url: "/busted",
               parent: "siteroot",
               templateUrl: "/app/home.partial.html",
               resolve: {
                 busted: function () {
                   return x + y + x;
                 }
               }
             });

    $urlRouterProvider.rule(function ($injector, $location) {

      // Handle the case of going to index.html without #/
      if ($location.url() === "") {
        return "/";
      }

    });

  }

  angular.module("moonshot")
    .config(ModuleInit);
})();

(function () {

  function AuthzResponseRedirect($q, $injector) {

    return {
      responseError: function (rejection) {
        var
          $state = $injector.get('$state'),
          $alert = $injector.get('$alert');

        // We can get an /api/ response of forbidden for
        // some data needed in a view. Flash an alert saying that this
        // data was requested.
        var url = rejection.config.url;
        if (rejection.status == 403 || rejection.status == 401) {
          // Redirect to the login form
          $state.go('siteroot.login');
          var msg = 'Login required for: ' + url;
          $alert({
                   content: msg,
                   animation: 'fadeZoomFadeDown',
                   type: 'material',
                   duration: 3
                 });
        }
        return $q.reject(rejection);
      }
    };

  }

  function AuthzStateRedirect($rootScope, $state, $auth) {
    // A state can be annotated with a value indicating
    // the state requires login.

    $rootScope.$on("$stateChangeStart", function (event, toState) {
      if (toState.authenticate && !$auth.isAuthenticated()) {
        // User isnâ€™t authenticated
        $state.transitionTo("siteroot.login");
        event.preventDefault();
      }
    });
  }

  function ModuleInit($httpProvider, $authProvider) {

    $httpProvider.interceptors.push('authzRedirect');

    var baseUrl = 'http://127.0.0.1:3000';

    // Satellizer setup
    $authProvider.loginUrl = baseUrl + '/api/auth/login';
    $authProvider.signupUrl = baseUrl + '/api/auth/signup';
    $authProvider.twitter({
                            url: baseUrl + '/api/auth/twitter'
                          });
  }

  angular.module("moonshot")
    .factory('authzRedirect', AuthzResponseRedirect)
    .config(ModuleInit)
    .run(AuthzStateRedirect);

})();


(function () {


  function LoginCtrl($auth, $alert) {
    this.login = function ($valid, username, password) {
      $auth.login({ username: username, password: password })
        .then(function () {
                $alert({
                         content: 'You have successfully logged in',
                         animation: 'fadeZoomFadeDown',
                         type: 'material',
                         duration: 3
                       });
              })
        .catch(function (response) {
                 $alert({
                          content: response.data.message,
                          animation: 'fadeZoomFadeDown',
                          type: 'material',
                          duration: 3
                        });
               });

    };

    this.authenticate = function (provider) {
      $auth.authenticate(provider)
        .then(function () {
                $alert({
                         content: 'You have successfully logged in',
                         animation: 'fadeZoomFadeDown',
                         type: 'material',
                         duration: 3
                       });
              })
        .catch(function (response) {
                 $alert({
                          content: response.data,
                          animation: 'fadeZoomFadeDown',
                          type: 'material',
                          duration: 3
                        });
               });
    };
  }

  function LogoutCtrl($auth, $state, $alert) {
    $auth.logout()
      .then(function () {
              $alert({
                       content: 'You have been logged out',
                       animation: 'fadeZoomFadeDown',
                       type: 'material',
                       duration: 3
                     });
              $state.go('siteroot.site');
            });
  }

  function ProfileCtrl(profile) {
    this.profile = profile.data.user;
  }

  angular.module("moonshot")
    .controller("LoginCtrl", LoginCtrl)
    .controller("LogoutCtrl", LogoutCtrl)
    .controller('ProfileCtrl', ProfileCtrl);

})();

(function () {

  function ModuleInit(moonshotMockRestProvider) {

    var user = {
      id: 'admin',
      email: 'admin@x.com',
      first_name: 'Admin',
      last_name: 'Lastie',
      twitter: 'admin'
    };

    moonshotMockRestProvider.addMock(
      'auth',
      [
        [
          'POST',
          /api\/auth\/login/,
          function (method, url, data) {
            data = angular.fromJson(data);
            var un = data.username;
            var response;

            if (un === 'admin') {
              response = [204, {token: "mocktoken"}];
            } else {
              response = [401, {"message": "Invalid login or password"}];
            }

            return response;
          }],
        [
          'GET', /api\/me/,
          function () {
            return [200, {user: user}];
          }
        ]
      ]);
  }

  angular.module('moonshot')
    .config(ModuleInit);

})();



(function () {

  function Profile($http) {
    return {
      getProfile: function () {
        return $http.get('/api/me');
      },
      updateProfile: function (profileData) {
        return $http.put('/api/me', profileData);
      },
      getUsers: function () {
        return $http.get('/api/users');
      }
    };
  }

  angular.module("moonshot")
    .factory('Profile', Profile);

})();

(function () {

  function ModuleInit($stateProvider) {

    $stateProvider
      .state('siteroot.login', {
               url: '/login',
               views: {
                 'content': {
                   templateUrl: '/auth/login.partial.html',
                   controller: 'LoginCtrl as LoginCtrl'
                 }
               }
             })
      .state('siteroot.logout', {
               url: '/logout',
               views: {
                 'content': {
                   controller: 'LogoutCtrl as LogoutCtrl'
                 }
               }
             })
      .state('siteroot.profile', {
               url: '/profile',
               authenticate: true,
               views: {
                 'content': {
                   templateUrl: '/auth/profile.partial.html',
                   controller: 'ProfileCtrl as ProfileCtrl'
                 }
               },
               resolve: {
                 profile: function (Profile, $alert) {
                   return Profile.getProfile()
                     .error(function (error) {
                              $alert({
                                       content: error.message,
                                       animation: 'fadeZoomFadeDown',
                                       type: 'material',
                                       duration: 3
                                     });
                            });
                 }
               }
             });

  }

  angular.module("moonshot")
    .config(ModuleInit);
})();

(function () {

  function FoldersHomeCtrl() {

  }

  function RootFolderDefaultCtrl(Traverser) {
    this.context = Traverser.context;
  }

  function FolderDefaultCtrl(Traverser) {
    this.context = Traverser.context;
  }


  angular.module("moonshot")
    .controller("FoldersHomeCtrl", FoldersHomeCtrl)
    .controller("RootFolderDefaultCtrl", RootFolderDefaultCtrl)
    .controller("FolderDefaultCtrl", FolderDefaultCtrl);


})();

(function () {

  function ModuleInit(moonshotMockRestProvider) {

    /*

    Folders
    ---------
    context
      - id, name, resourceType, markers, _self
      - items
    path
    viewName
    parents
     */

    var
      f1a = {path: '/root/folder1/foldera', id: 10, resourceType: 'Folder',
        title: 'Folder 1A', viewName: 'default', items: [],
        markers: ['invoices']},
      f1b = {path: '/root/folder1/folderB', id: 11, resourceType: 'Folder',
        title: 'Folder 1B', viewName: 'default', items: []},
      f1 = {path: '/root/folder1', id: 1, resourceType: 'Folder',
        title: 'Folder One', viewName: 'default',
        items: [f1a, f1b]},
      f2 = {path: '/root/folder2', id: 2, resourceType: 'Folder',
        title: 'Another Folder', viewName: 'default', items: []},
      rf = {path: '/root', id: 0, resourceType: 'RootFolder',
        title: 'Root Folder', viewName: 'default', items: [f1, f2]};

    // Assemble some parentage
    f1a.parents = [rf, f1];
    f1b.parents = [rf, f1];
    f1.parents = [rf];
    var sampleData = [f1, f2, rf, f1a, f1b];

    function resolvePath(method, url, data) {
      /* Given a path, return context, viewName, parents */

      var path = url.substring(4);
      var context = _.find(sampleData, {path: path});
      var viewName = context.viewName;
      var parents = context.parents;
      var responseData = {context: context, viewName: viewName, parents: parents};

      return [200, {data: responseData}];
    }

    moonshotMockRestProvider.addMock(
      'traverser',
      [
        ['GET', /api\/root/, resolvePath]
      ]);
  }

  angular.module('moonshot')
    .config(ModuleInit);

})();



(function () {

  function ModuleInit($stateProvider) {

    var subsections = [
      {label: 'Home', state: 'folder-home'}
    ];

    $stateProvider

      // Folder views driven by routes
      .state("folder-home", {
               url: "/folder",
               parent: "siteroot",
               section: {
                 title: "Folders",
                 priority: 2
               },
               subsections: subsections,
               views: {
                 "content": {
                   templateUrl: "/folder/folder-home.partial.html"
                 }
               }
             })

      // Now some folder views driven by traversal
      .state("rootfolder-default", {
               parent: "siteroot",
               viewConfig: {
                 name: 'default',
                 resourceType: 'RootFolder'
               },
               views: {
                 "content": {
                   templateUrl: "/folder/rootfolder-default.partial.html",
                   controller: "RootFolderDefaultCtrl as rfdctrl"
                 }
               }
             })

      .state("folder-default", {
               parent: "siteroot",
               viewConfig: {
                 name: 'default',
                 resourceType: 'Folder'
               },
               views: {
                 "content": {
                   templateUrl: "/folder/folder-default.partial.html",
                   controller: "FolderDefaultCtrl as fdctrl"
                 }
               }
             })

      .state("invoicefolder-default", {
               parent: "siteroot",
               viewConfig: {
                 name: 'default',
                 resourceType: 'Folder',
                 marker: 'invoices'
               },
               views: {
                 "content": {
                   templateUrl: "/folder/invoicefolder-default.partial.html",
                   controller: "FolderDefaultCtrl as fdctrl"
                 }
               }
             });
  }

  angular.module("moonshot")
    .config(ModuleInit);

})();



(function () {

    function SiteFormCtrl($log) {
      $log.debug('SiteFormCtrl');
  }

  angular.module("moonshot")
    .controller("SiteFormCtrl", SiteFormCtrl);


})();

(function () {

  function ModuleInit($stateProvider) {

    var subsections = [
      {label: 'Home', state: 'siteroot.site'},
      {label: 'Form', state: 'siteroot.site.form'}
    ];

    $stateProvider
      .state("siteroot.site", {
               url: "/",
               section: {
                 title: "Home",
                 priority: 1
               },
               subsections: subsections,
               views: {
                 "content": {
                   templateUrl: "/site/home.partial.html"
                 }
               }
             })
      .state("siteroot.site.form", {
               url: "form",
               views: {
                 "content@siteroot": {
                   templateUrl: "/site/form.partial.html",
                   controller: "SiteFormCtrl as SiteFormCtrl"
                 }
               }
             });
  }

  angular.module("moonshot")
    .config(ModuleInit);

})();



(function () {

  function TraverserCtrl($state, resolvedPath, Traverser) {

    // First hande the case where resolvedPath says it couldn't
    // find anything.

    if (resolvedPath.error) {
      // This should be a not found
      $state.go('notfound');
    }

    var data = resolvedPath.data.data;
    Traverser.context = data.context;
    Traverser.viewName = data.viewName;
    Traverser.parents = data.parents;

    // Get the next state. Look in all the registered states at
    // view_config information.
    var nextState = Traverser.resolveState(
      Traverser.context, Traverser.viewName, Traverser.parents);

    if (nextState) {
      $state.go(nextState);
    } else {
      // Traverser failed to find a matching view
      $state.go('notfound');
    }

  }

  angular.module("moonshot")
    .controller("TraverserCtrl", TraverserCtrl);

})();

(function () {

  function ModuleConfig($urlRouterProvider) {

    $urlRouterProvider.otherwise(function ($injector) {
      // The URL failed to resolve. Let's give a try at traversal.
      var
        $state = $injector.get('$state'),
        Traverser = $injector.get('Traverser');

      // If there are viewConfig settings on any states, use traversal
      if (!Traverser.disableTraversal) {
        $state.go('siteroot.traverse');
      } else {
        $state.go("notfound", {unfoundStateTo: 'siteroot.traverse'});
      }
    });

  }

  function ModuleRun($rootScope, $state, Traverser) {

    // Put the Traverser on the root scope so that it is available in
    // all templates.
    $rootScope.traverser = Traverser;

    // Grab all the registered view_config info from the states. Make
    // a dict with a key of the view name, value all the view_config
    // info.
    Traverser.makeViewMap($state.get());

    // Not Found. Tried to go to a state that doesn't exist.
    $rootScope
      .$on(
      '$stateNotFound',
      function (event, unfoundState, fromState, fromParams) {
        event.preventDefault();
        $state.go("notfound", {unfoundStateTo: unfoundState.to});
      });

    // Error handler. Display errors that occur in state resolves etc.
    $rootScope
      .$on(
      '$stateChangeError',
      function (event, toState, toParams, fromState, fromParams, error) {
        console.debug('$stateChangeError', error);

        event.preventDefault();
        $state.go("error", {toState: toState.name, error: error});

      });
  }

  angular.module("moonshot")
    .config(ModuleConfig)
    .run(ModuleRun);

})();

(function () {

  function Traverser($http) {
    var _this = this;

    this.x = 1;

    // At startup, take the list of states and make a viewMap. The
    // viewMap will look like:
    // default:
    //   [
    //      {resourceType: 'Folder', containment: something,
    //       stateName: 'folder-default'
    //      }
    //   ]
    // Meaning, it has the predicate information used in Pyramid
    // views. We key on viewName just to speed up the resolution.
    this.viewMap = {};
    this.makeViewMap = function (states) {
      this.viewMap = {};
      _(states)
        .filter(function (state) {
                  return _.has(state, "viewConfig");
                })
        .forEach(function (state) {
                   var vc = state.viewConfig;
                   if (vc) {
                     // This state has a viewConfig
                     var viewName = vc.name;

                     // If the viewMap doesn't yet have this
                     // viewName, add it with an empty seq
                     if (!_this.viewMap[viewName]) {
                       _this.viewMap[viewName] = [];
                     }
                     // Now push info from this state onto the viewMap
                     _this.viewMap[viewName].push(
                       {
                         name: vc.name,
                         resourceType: vc.resourceType,
                         stateName: state.name,
                         marker: vc.marker
                       }
                     );

                   }
                 });

      this.disableTraversal = _.isEmpty(this.viewMap);
    };

    this.resolvePath = function (path) {
      return $http.get('/api' + path);
    };

    this.resolveState = function (context, viewName, parents) {
      // Based on request info, find the matching view in the view
      // map based on priority.

      // Get the view matching this resolved viewName from the viewMap
      var views = _this.viewMap[viewName];

      // Get some of the data needed by the predicates
      var
        resourceType = context.resourceType,
        parentTypes = _.uniq(_.map(parents, function (p) {
          return p.resourceType;
        })),
//        markers = _.map(parents, function (p) {
//          return p.markers;
//        }),
//        parentMarkers = _.uniq(_.flatten(markers)),
        markers = context.markers;
      pathInfo = context.path;

      // Go through all the views, assigning a score
      var matchingView = null;
      var viewResults = _.map(views, function (viewConfig) {
        if (!matchingView) {
          // Initialize all the possible predicates
          var r = {stateName: viewConfig.stateName};
          r.isResourceType = false;
          r.inParentTypes = false;
          r.inMarkers = false;
//          inParentMarkers = false,
          r.inPathInfo = false;

          r.score = 0;


          // If this viewConfig states each predicate case, and it matches,
          // set to true.

          if (!_.has(viewConfig, 'resourceType')) {
            // Special case...if the viewConfig does *not* specify a
            // resourceType, it means match any resourceType;
            r.isResourceType = true;
          }
          if (viewConfig.resourceType) {
            r.isResourceType = viewConfig.resourceType === resourceType;
          }
          if (viewConfig.containment) {
            r.inParentTypes = _.contains(parentTypes, viewConfig.contains);
          }
          if (viewConfig.marker) {
//          inParentMarkers = _.contains(parentMarkers, viewConfig.marker);
            r.inMarkers = _.contains(markers, viewConfig.marker);
          }
          if (viewConfig.pathInfo) {
            r.inPathInfo = _.contains(pathInfo, viewConfig.pathInfo);
          }

          return r;
        }
      });

      console.debug(488448, viewResults);

      return matchingView;
    };

    this.transitionTo = function (context, viewName, parents) {
      // If the state map isn't generated, then generate it
      var views = this.getViewMap();

      // Find all view declarations for this viewName

      // Based on priority settings,
    };
  }

  angular.module("traverser", [])
    .service("Traverser", Traverser);

})();

(function () {

  function ModuleInit($stateProvider) {

    $stateProvider
      .state("siteroot.traverse", {
               views: {
                 "content@siteroot": {
                   template: "",
                   controller: "TraverserCtrl as TraverserCtrl",
                   resolve: {
                     resolvedPath: function (Traverser, $location, $alert) {
                       var path = $location.path();
                       return Traverser.resolvePath(path)
                         .catch(function (response) {
                                  var msg = 'Traversal error: ' + response.data.message;
                                  $alert({
                                           content: msg,
                                           animation: 'fadeZoomFadeDown',
                                           type: 'material',
                                           duration: 3
                                         });
                                });
                     }
                   }
                 }
               }
             });
  }

  angular.module("moonshot")
    .config(ModuleInit);

})();



(function () {

  function UsersHomeCtrl(users) {
    this.users = users.data.data;
  }

  angular.module('moonshot')
    .controller('UsersHomeCtrl', UsersHomeCtrl);
})();

(function () {

  function ModuleInit(moonshotMockRestProvider) {

    var usersData = {
      data: [
        {
          'id': 'bob',
          'title': 'Bob Jones'
        }
      ]
    };

    moonshotMockRestProvider.addMock(
      'users',
      [
        [
          'GET',
          /api\/users$/,
          function () {
            return [200, usersData];
          }]
      ]);
  }

  angular.module('moonshot')
    .config(ModuleInit);

})();



(function () {

  function Users($http) {
    return {
      getUsers: function () {
        return $http.get('/api/users');
      }
    };
  }

  angular.module("moonshot")
    .factory('Users', Users);

})();

(function () {

  function ModuleInit($stateProvider) {

    var subsections = [
      {label: 'Home', state: 'users'}
    ];

    $stateProvider
      .state('users', {
               url: '/users/',
               parent: 'siteroot',
               authenticate: true,
               section: {
                 title: 'Users',
                 priority: 1
               },
               subsections: subsections,
               views: {
                 content: {
                   templateUrl: '/user/users-home.partial.html',
                   controller: 'UsersHomeCtrl as UsersHomeCtrl'
                 }
               },
               resolve: {
                 users: function (Users, $alert) {
                   return Users.getUsers()
                     .error(function (error) {
                              $alert({
                                       content: error.message,
                                       animation: 'fadeZoomFadeDown',
                                       type: 'material',
                                       duration: 3
                                     });
                            });
                 }
               }
             });
  }

  angular.module('moonshot')
    .config(ModuleInit);

})();



//# sourceMappingURL=moonshot.min.js.map